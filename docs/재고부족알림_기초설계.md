# 재고 부족 알림 (Push Notification) 기초 설계

## 1. 개요

DB(Supabase)를 주기적으로 체크하여 **현재 재고 ≤ 기준 재고**인 품목이 있으면 앱 상단에 알림 배너를 표시하고, 알림 센터(종 아이콘)에 빨간 점 배지를 띄우는 기능입니다.

---

## 2. 로직 (Logic)

### 2.1 데이터 소스
- **테이블**: `재고` (Supabase)
- **조건**: `base_stock`이 설정된 행 중, `data` JSON에서 추출한 현재 재고 < `base_stock`

### 2.2 판별 로직
```
현재재고 = data JSON에서 재고 컬럼 추출 (findStockValue 로직 활용)
기준재고 = base_stock

재고 부족 = 현재재고 < 기준재고
```

### 2.3 API 활용
- **기존 API**: `GET /api/inventory/check-alarm`  
  - `alarm_status = true`인 행만 반환
  - `file_name` 파라미터로 파일별 필터 가능 (생략 시 전체)
- **확장 필요**: 응답에 `품목명` 포함  
  - `data` JSON에서 품목명 컬럼 추출 (품목, 품목명, 상품명 등 키워드 매칭)

### 2.4 체크 주기
- **초기 로드**: 앱 진입 시 1회
- **주기적 폴링**: 5분 간격 (또는 설정 가능)
- **선택**: Supabase Realtime 구독으로 `재고` 테이블 변경 시 즉시 반영

---

## 3. 알림 문구 (Alert Message)

### 3.1 단일 품목
```
경고: [품목명]의 재고가 [현재재고]개 남았습니다. 발주가 필요합니다.
```

### 3.2 복수 품목
- **배너**: 가장 부족한 1개 품목 메시지 + "외 N개"
- **알림 센터**: 품목별로 리스트 표시

예시:
```
경고: [품목A]의 재고가 3개 남았습니다. 발주가 필요합니다. (외 2개)
```

---

## 4. UI 설계

### 4.1 알림 센터 (종 아이콘)
- **위치**: 앱 메인 화면 상단 우측 (헤더 영역)
- **아이콘**: 종 모양 (Bell icon)
- **상태**:
  - 기본: 회색 종
  - 새 알림 있음: 빨간 점 배지 (absolute, 우상단)

```
┌─────────────────────────────────────────┐
│  Excel Manager              [🔔] ← 종    │
│                              ●  ← 빨간점 │
└─────────────────────────────────────────┘
```

### 4.2 상단 알림 배너
- **위치**: 헤더 바로 아래, 전체 너비
- **스타일**: 빨간/주황 그라데이션 배경, 흰색 텍스트
- **동작**: 클릭 시 해당 품목 상세 또는 알림 센터로 이동
- **닫기**: X 버튼으로 배너 숨김 (세션 동안만, 새 알림 시 다시 표시)

```
┌─────────────────────────────────────────┐
│ ⚠️ 경고: [품목명]의 재고가 3개 남았습니다.  │
│    발주가 필요합니다. (외 2개)        [X] │
└─────────────────────────────────────────┘
```

### 4.3 알림 센터 드로어/모달
- **트리거**: 종 아이콘 클릭
- **내용**: 재고 부족 품목 리스트
  - 품목명
  - 현재재고 / 기준재고
  - 부족 수량
  - 클릭 시 해당 파일/행 편집 페이지로 이동

---

## 5. 컴포넌트 구조

```
Layout (또는 공통 헤더)
├── NotificationBell        ← 종 아이콘 + 빨간점
│   └── onClick → 알림 센터 열기
├── LowStockBanner          ← 상단 배너 (조건부 렌더)
│   └── 메시지 + 닫기
└── NotificationCenter      ← 모달/드로어 (종 클릭 시)
    └── LowStockItem[] 리스트
```

### 5.1 데이터 흐름
```
[앱 로드/폴링]
    → GET /api/inventory/check-alarm
    → { alerts: [{ id, fileName, itemName, currentStock, baseStock, ... }] }
    → NotificationContext 또는 props
    → NotificationBell (배지), LowStockBanner, NotificationCenter
```

---

## 6. API 확장 제안

### 6.1 `GET /api/inventory/check-alarm` 응답 확장
현재 `alarm_status=true` 행만 반환하므로, 응답에 **품목명** 추가:

```json
{
  "success": true,
  "count": 3,
  "alerts": [
    {
      "id": 123,
      "fileName": "재고현황.xlsx",
      "rowIndex": 5,
      "itemName": "품목A",
      "currentStock": 3,
      "baseStock": 10,
      "shortage": 7,
      "data": { ... }
    }
  ]
}
```

### 6.2 품목명 추출 로직
- `data` JSON에서 키워드 매칭: `품목`, `품목명`, `상품명`, `제품명`, `name`, `item` 등
- 없으면 `"품목 #행번호"` fallback

---

## 7. 구현 우선순위

| 순서 | 항목 | 설명 |
|------|------|------|
| 1 | API 확장 | check-alarm GET에 itemName, shortage 추가 |
| 2 | NotificationBell | 레이아웃에 종 아이콘 + 빨간점 배지 |
| 3 | LowStockBanner | 상단 배너 컴포넌트 |
| 4 | NotificationCenter | 알림 리스트 모달/드로어 |
| 5 | 폴링/Realtime | 주기적 체크 또는 실시간 구독 |

---

## 8. 참고: 기존 코드

- `StockAlert` (src/components/StockAlert.tsx): 파일별 재고 체크, 상단 배너/팝업
- `GET /api/inventory/check-alarm`: alarm_status 기반 조회
- `findStockValue`, `findItemName`: data JSON 파싱 유틸
